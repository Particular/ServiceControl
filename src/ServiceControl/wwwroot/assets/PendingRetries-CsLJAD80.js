import{e as me,u as ye,aD as we,s as be,ay as Se,r as a,ap as Ce,w as he,ad as ke,o as Ae,p as c,n as r,x as f,v as n,aq as De,q as t,m as T,t as p,y as g,_ as q,z as i,aE as Re,aF as $e,a7 as _e,aG as Ie,K,L as W,B as b,aH as Te,ah as S,aI as Me,ai as Fe,av as Z,aw as J,ar as Oe,as as xe,aJ as Y,aK as j,a5 as Pe,T as qe,C,ax as Ee,S as He,aC as Le,P as E,Q as H,U as Ne}from"./index-Cy3_77ur.js";import{O as Be}from"./OrderBy-BkxwTXBU.js";import{M as Ve}from"./MessageList-Bv6PeXYU.js";const Ue={name:"pending_retries"},Ge={class:"row"},Qe={class:"col-12"},ze={class:"alert alert-info"},Ke={href:"https://docs.particular.net/nservicebus/operations/auditing",target:"_blank"},We={key:0,class:"col-12"},Ze={class:"row"},Je={class:"col-6"},Ye={class:"filter-input"},je={class:"input-group mb-3"},Xe={class:"input-group-text"},es=["value"],ss={class:"input-group-btn"},ts={class:"col-6"},os={class:"msg-group-menu dropdown"},as={type:"button",class:"btn btn-default dropdown-toggle sp-btn-menu","data-bs-toggle":"dropdown","aria-haspopup":"true","aria-expanded":"false"},ns={class:"dropdown-menu"},ls=["onClick"],rs={class:"row"},is={class:"col-6 col-xs-12 toolbar-menus"},ds={class:"action-btns"},us={class:"row"},cs={class:"col-12"},vs={class:"row"},X=50,fs=me({__name:"PendingRetries",setup(ps){const v=ye(),ee=we(),{isMassTransitConnected:se}=be(ee);let M,F;const L=Se().cookies,h=a("All Pending Retries"),N=a([]),l=Ce("messageList"),k=a([]),d=a("empty"),A=a(!1),D=a(!1),R=a(!1),$=a(!1),_=a(!1),I=a(1),B=a(0),V=a(!0),te=[{description:"Time of failure",iconAsc:J,iconDesc:Z},{description:"Message Type",iconAsc:xe,iconDesc:Oe},{description:"Time of retry request",iconAsc:J,iconDesc:Z}],U=["All Pending Retries","Retried in the last 2 Hours","Retried in the last 1 Day","Retried in the last 7 Days"];he(I,()=>u());async function oe(){const[,s]=await v.fetchTypedFromServiceControl("errors/queues/addresses");N.value=s.map(e=>e.physical_address)}function ae(){d.value="empty",u()}function u(){let s=new Date(0);const e=new Date;switch(h.value){case"Retried in the last 2 Hours":s=new Date,s.setHours(s.getHours()-2);break;case"Retried in the last 1 Day":s=new Date,s.setHours(s.getHours()-24);break;case"Retried in the last 7 days":s=new Date,s.setHours(s.getHours()-168);break}return ne(I.value,d.value,s,e,F?.description.replaceAll(" ","_").toLowerCase(),F?.dir)}async function ne(s,e,o,m,O,z){O??="time_of_failure",z??=He.Descending,e==="empty"&&(e="");try{const[x,P]=await v.fetchTypedFromServiceControl(`errors?status=${Le.RetryIssued}&page=${s}&per_page=${X}&sort=${O}&direction=${z}&queueaddress=${e}&modified=${o.toISOString()}...${m.toISOString()}`);B.value=parseInt(x.headers.get("Total-Count")??"0"),k.value.forEach(y=>{const w=P.find(ge=>ge.id===y.id);w&&(y.last_modified===w.last_modified&&(w.submittedForRetrial=y.submittedForRetrial,w.resolved=y.resolved),w.selected=y.selected)}),k.value=P}catch(x){return console.log(x),{message:"error"}}}function le(){return l.value?.numberDisplayed()}function re(){return l.value?.isAnythingDisplayed()}function G(){return l.value?.isAnythingSelected()}function Q(){return l.value?.getSelectedMessages()?.length??0}async function ie(){const s=l.value?.getSelectedMessages()??[];E(H.INFO,"Info","Selected messages were submitted for retry..."),await v.postToServiceControl("pendingretries/retry",s.map(e=>e.id)),l.value?.deselectAll(),s.forEach(e=>e.submittedForRetrial=!0)}async function de(){const s=l.value?.getSelectedMessages()??[];E(H.INFO,"Info","Selected messages were marked as resolved."),await v.patchToServiceControl("pendingretries/resolve",{uniquemessageids:s.map(e=>e.id)}),l.value?.deselectAll(),s.forEach(e=>e.resolved=!0)}async function ue(){E(H.INFO,"Info","All filtered messages were marked as resolved."),await v.patchToServiceControl("pendingretries/resolve",{from:new Date(0).toISOString(),to:new Date().toISOString()}),l.value?.deselectAll(),l.value?.resolveAll()}async function ce(){let s="pendingretries/retry";const e={from:new Date(0).toISOString(),to:new Date(0).toISOString()};d.value!=="empty"&&(s="pendingretries/queues/retry",e.queueaddress=d.value),await v.postToServiceControl(s,e),k.value.forEach(o=>{o.selected=!1,o.submittedForRetrial=!0,o.retried=!1})}function ve(){d.value==="empty"?$.value=!0:_.value=!0}function fe(s){F=s,V.value||u()}function pe(s){h.value=s,L.set("pending_retries_period",s),u()}return ke(()=>{M!=null&&window.clearInterval(M)}),Ae(()=>{let s=L.get("pending_retries_period");s||(s=U[0]),h.value=s,oe(),u(),M=window.setInterval(()=>{u()},5e3),V.value=!1}),(s,e)=>(r(),c(Ee,null,{default:f(()=>[n(De,null,{default:f(()=>[t("section",Ue,[t("div",Ge,[t("div",Qe,[t("div",ze,[n(q,{icon:i(Re),class:"icon info"},null,8,["icon"]),e[19]||(e[19]=g(" To check if a retried message was also processed successfully, enable ",-1)),t("a",Ke,[e[18]||(e[18]=g("message auditing ",-1)),n(q,{icon:i($e)},null,8,["icon"])])])]),i(se)?(r(),T("div",We,[...e[20]||(e[20]=[t("div",{class:"alert alert-info"},"MassTransit endpoints currently do not report when a pending retry has succeeded, and therefore any messages associated with those endpoints will need to be manually marked as resolved.",-1)])])):p("",!0)]),t("div",Ze,[t("div",Je,[t("div",Ye,[t("div",je,[t("label",Xe,[n(q,{icon:i(Ie),size:"sm",class:"icon"},null,8,["icon"]),e[21]||(e[21]=g()),e[22]||(e[22]=t("span",{class:"hidden-xs"},"Filter",-1))]),_e(t("select",{class:"form-select",id:"inputGroupSelect01",onchange:"this.dataset.chosen = true;",onChange:e[0]||(e[0]=o=>u()),"onUpdate:modelValue":e[1]||(e[1]=o=>d.value=o)},[e[23]||(e[23]=t("option",{selected:"",disabled:"",hidden:"",class:"placeholder",value:"empty"},"Select a queue...",-1)),(r(!0),T(K,null,W(N.value,(o,m)=>(r(),T("option",{key:m,value:o},b(o),9,es))),128))],544),[[Te,d.value]]),t("span",ss,[n(S,{onClick:e[2]||(e[2]=o=>ae()),icon:i(Me)},null,8,["icon"])])])])]),t("div",ts,[t("div",os,[e[25]||(e[25]=t("label",{class:"control-label"},"Period:",-1)),t("button",as,[g(b(h.value)+" ",1),e[24]||(e[24]=t("span",{class:"caret"},null,-1))]),t("ul",ns,[(r(),T(K,null,W(U,(o,m)=>t("li",{key:m},[t("a",{onClick:Fe(O=>pe(o),["prevent"])},b(o),9,ls)])),64))])]),n(Be,{onSortUpdated:fe,hideGroupBy:!0,sortOptions:te,sortSavePrefix:"pending_retries"})])]),t("div",rs,[t("div",is,[t("div",ds,[n(S,{icon:i(Y),disabled:!G(),onClick:e[3]||(e[3]=o=>A.value=!0)},{default:f(()=>[e[26]||(e[26]=t("span",null,"Retry",-1)),g(" ("+b(Q())+")",1)]),_:1},8,["icon","disabled"]),n(S,{icon:i(j),disabled:!G(),onClick:e[4]||(e[4]=o=>D.value=!0)},{default:f(()=>[e[27]||(e[27]=t("span",null,"Mark as resolved",-1)),g(" ("+b(Q())+")",1)]),_:1},8,["icon","disabled"]),n(S,{icon:i(Y),disabled:!re(),onClick:e[5]||(e[5]=o=>ve())},{default:f(()=>[...e[28]||(e[28]=[t("span",null,"Retry all",-1)])]),_:1},8,["icon","disabled"]),n(S,{icon:i(j),onClick:e[6]||(e[6]=o=>R.value=!0)},{default:f(()=>[...e[29]||(e[29]=[t("span",null,"Mark all as resolved",-1)])]),_:1},8,["icon"])])])]),t("div",us,[t("div",cs,[n(Ve,{messages:k.value,ref_key:"messageList",ref:l},null,8,["messages"])])]),t("div",vs,[n(Pe,{modelValue:I.value,"onUpdate:modelValue":e[7]||(e[7]=o=>I.value=o),"total-count":B.value,"items-per-page":X},null,8,["modelValue","total-count"])]),(r(),c(qe,{to:"#modalDisplay"},[A.value===!0?(r(),c(C,{key:0,onCancel:e[8]||(e[8]=o=>A.value=!1),onConfirm:e[9]||(e[9]=o=>{A.value=!1,ie()}),heading:"Are you sure you want to retry the selected messages?",body:"Ensure that the selected messages were not processed previously as this will create a duplicate message.","second-paragraph":"NOTE: If the selection includes messages to be processed via unaudited endpoints, those messages will need to be marked as resolved once the retry is manually verified"})):p("",!0),D.value===!0?(r(),c(C,{key:1,onCancel:e[10]||(e[10]=o=>D.value=!1),onConfirm:e[11]||(e[11]=o=>{D.value=!1,de()}),heading:"Are you sure you want to mark as resolved the selected messages?",body:"If you mark these messages as resolved they will not be available for Retry. Messages should only be marked as resolved only if they belong to unaudited endpoints."})):p("",!0),R.value===!0?(r(),c(C,{key:2,onCancel:e[12]||(e[12]=o=>R.value=!1),onConfirm:e[13]||(e[13]=o=>{R.value=!1,ue()}),heading:"Are you sure you want to resolve all messages?",body:`Are you sure you want to mark all ${le()} messages as resolved? If you do they will not be available for Retry.`},null,8,["body"])):p("",!0),$.value===!0?(r(),c(C,{key:3,onCancel:e[14]||(e[14]=o=>$.value=!1),onConfirm:e[15]||(e[15]=o=>$.value=!1),"hide-cancel":!0,heading:"Select a queue first",body:"Bulk retry of messages can only be done for one queue at the time to avoid producing unwanted message duplicates."})):p("",!0),_.value===!0?(r(),c(C,{key:4,onCancel:e[16]||(e[16]=o=>_.value=!1),onConfirm:e[17]||(e[17]=o=>{_.value=!1,ce()}),heading:"Confirm retry of all messages?",body:"Are you sure you want to retry all previously retried messages? If the selected messages were processed in the meanwhile, then duplicate messages will be produced."})):p("",!0)]))])]),_:1})]),_:1}))}}),ws=Ne(fs,[["__scopeId","data-v-492585ac"]]);export{ws as default};
//# sourceMappingURL=PendingRetries-CsLJAD80.js.map
