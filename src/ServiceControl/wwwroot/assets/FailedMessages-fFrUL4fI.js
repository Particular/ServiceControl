import{e as de,u as ce,f as fe,r as p,ap as ge,w as ve,az as me,ad as ye,o as pe,p as f,n,x as g,v as w,aq as we,q as u,m as Z,t as v,B as $,ah as h,y as C,z as D,ag as J,J as K,aA as he,av as Ce,aw as Se,ar as Ie,as as Ae,a5 as be,T as ke,C as U,ax as Me,S as $e,P,Q as _,aB as De,aC as Pe}from"./index-C-3C3fiy.js";import{c as _e}from"./messageGroupClient-8SmTpJE8.js";import{O as Re}from"./OrderBy-Cbte9BkY.js";import{M as xe}from"./MessageList-DnOFCH0O.js";import{u as Fe}from"./MessageStore-BIIxDMkG.js";const Oe={name:"message_groups"},Ee={key:0,class:"row"},Ne={class:"col-sm-12"},Te={key:0,class:"active break group-title"},Ge={class:"active group-title group-message-count"},Be={class:"row"},Ve={class:"col-9"},qe={class:"btn-toolbar"},Le={class:"col-3"},Ue={class:"row"},je={class:"col-12"},ze={class:"row"},Q=50,He=de({__name:"FailedMessages",setup(We){const B=ce(),j=Fe(),z=_e();let R=!1,k,x;const Y=fe(),S=p(Y.params.groupId),I=p(""),F=p(1),V=p(0),O=p(!1),E=p(!1),N=p(!1),i=ge("messageList"),d=p([]),H=[{description:"Time of failure",iconAsc:Se,iconDesc:Ce},{description:"Message Type",iconAsc:Ae,iconDesc:Ie}];ve(F,()=>T());function X(t){x=t,T()}function T(){te(S.value,F.value,x&&x.description.replaceAll(" ","_").toLowerCase(),x?.dir)}async function ee(t){const s=await(await B.fetchFromServiceControl(`recoverability/groups/id/${t}`)).json();I.value=s.title}function te(t,e,s,G){s??="time_of_failure",G??=$e.Descending;let b;t&&!I.value&&(b=ee(t));async function L(){try{const[m,l]=await B.fetchTypedFromServiceControl(`${t?`recoverability/groups/${t}/`:""}errors?status=${Pe.Unresolved}&page=${e}&per_page=${Q}&sort=${s}&direction=${G}`);V.value=parseInt(m.headers.get("Total-Count")??""),d.value.length&&l.length&&d.value.forEach(r=>{const a=l.find(c=>c.id===r.id);a&&(r.last_modified===a.last_modified&&(a.retryInProgress=r.retryInProgress,a.deleteInProgress=r.deleteInProgress),a.selected=r.selected)}),d.value=l}catch(m){return console.log(m),{message:"error"}}}const o=L();return b?Promise.all([b,o]):o}async function se(t){A(1e3),P(_.INFO,"Info","Message retry requested..."),await j.retryMessages([t]);const e=d.value.find(s=>s.id===t);e&&(e.retryInProgress=!0,e.selected=!1)}async function oe(){A(1e3);const t=i.value?.getSelectedMessages()??[];P(_.INFO,"Info","Retrying "+t.length+" messages..."),await j.retryMessages(t.map(e=>e.id)),i.value?.deselectAll(),t.forEach(e=>e.retryInProgress=!0)}function ae(){function t(o){const l=Object.keys(o[0]);let r=l.join(",")+`
`;return o.forEach(a=>{r+=l.map(c=>{let y=String(a[c]);return y=y.replaceAll('"','""'),y.search(/([",\n])/g)>=0&&(y=`"${y}"`),y}).join(",")+`
`}),r}function e(o,m,l=""){const r=typeof o;let a={};if(o!=null&&r==="object"){for(const c in o){const y=e(o[c],m,l+c+".");a=Object.assign(a,y)}return a}else if(r==="number"||r==="string"||r==="boolean"||o==null){const c=l.substr(0,l.length-1);return m&&m.includes(c)||(a[c]=o),a}return a}const s=i.value?.getSelectedMessages()??[],G=["hover","selected","hover2","$$hashKey","panel","edit_of","edited"],b=[];for(let o=0;o<s.length;o++)b.push(e(s[o],G));const L=t(b);De(L,"text/csv","failedMessages.csv")}function q(){return i.value?.getSelectedMessages()?.length??0}function re(){i.value?.selectAll()}function le(){i.value?.deselectAll()}function M(){return i?.value?.isAnythingSelected()}async function ne(){A(1e3);const t=i.value?.getSelectedMessages()??[];P(_.INFO,"Info","Deleting "+t.length+" messages..."),await B.patchToServiceControl("errors/archive",t.map(e=>e.id)),i.value?.deselectAll(),t.forEach(e=>e.deleteInProgress=!0)}async function ie(){P(_.INFO,"Info","Retrying all messages..."),await z.retryExceptionGroup(S.value),d.value.forEach(t=>t.retryInProgress=!0)}async function ue(){P(_.INFO,"Info","Deleting all messages..."),await z.archiveExceptionGroup(S.value),d.value.forEach(t=>t.deleteInProgress=!0)}function W(){return d.value.some(t=>t.retryInProgress||t.deleteInProgress)}function A(t){k!=null&&window.clearInterval(k),k=window.setInterval(()=>{!R&&W()?(A(1e3),R=!0):R&&!W()&&(A(5e3),R=!1),T()},t)}return me(()=>{S.value="",I.value=""}),ye(()=>{k!=null&&window.clearInterval(k)}),pe(()=>{T(),A(5e3)}),(t,e)=>(n(),f(Me,null,{default:g(()=>[w(we,null,{default:g(()=>[u("section",Oe,[I.value&&d.value.length>0?(n(),Z("div",Ee,[u("div",Ne,[I.value?(n(),Z("h1",Te,$(I.value),1)):v("",!0),u("h3",Ge,$(V.value)+" messages in group",1)])])):v("",!0),u("div",Be,[u("div",Ve,[u("div",qe,[M()?v("",!0):(n(),f(h,{key:0,onClick:re},{default:g(()=>[...e[12]||(e[12]=[C("Select all",-1)])]),_:1})),M()?(n(),f(h,{key:1,onClick:le},{default:g(()=>[...e[13]||(e[13]=[C("Clear selection",-1)])]),_:1})):v("",!0),w(h,{icon:D(J),onClick:e[0]||(e[0]=s=>oe()),disabled:!M()},{default:g(()=>[C("Retry "+$(q())+" selected",1)]),_:1},8,["icon","disabled"]),w(h,{icon:D(K),onClick:e[1]||(e[1]=s=>O.value=!0),disabled:!M()},{default:g(()=>[C("Delete "+$(q())+" selected",1)]),_:1},8,["icon","disabled"]),w(h,{icon:D(he),onClick:e[2]||(e[2]=s=>ae()),disabled:!M()},{default:g(()=>[C("Export "+$(q())+" selected",1)]),_:1},8,["icon","disabled"]),S.value?(n(),f(h,{key:2,icon:D(J),onClick:e[3]||(e[3]=s=>E.value=!0)},{default:g(()=>[...e[14]||(e[14]=[C("Retry all",-1)])]),_:1},8,["icon"])):v("",!0),S.value?(n(),f(h,{key:3,icon:D(K),onClick:e[4]||(e[4]=s=>N.value=!0)},{default:g(()=>[...e[15]||(e[15]=[C("Delete all",-1)])]),_:1},8,["icon"])):v("",!0)])]),u("div",Le,[w(Re,{onSortUpdated:X,sortOptions:H,sortSavePrefix:"all_failed_"})])]),u("div",Ue,[u("div",je,[w(xe,{messages:d.value,"show-request-retry":!0,onRetryRequested:se,ref_key:"messageList",ref:i},null,8,["messages"])])]),u("div",ze,[w(be,{modelValue:F.value,"onUpdate:modelValue":e[5]||(e[5]=s=>F.value=s),"total-count":V.value,"items-per-page":Q},null,8,["modelValue","total-count"])]),(n(),f(ke,{to:"#modalDisplay"},[O.value?(n(),f(U,{key:0,onCancel:e[6]||(e[6]=s=>O.value=!1),onConfirm:e[7]||(e[7]=s=>{O.value=!1,ne()}),heading:"Are you sure you want to delete the selected messages?",body:"If you delete, these messages won't be available for retrying unless they're later restored."})):v("",!0),E.value?(n(),f(U,{key:1,onCancel:e[8]||(e[8]=s=>E.value=!1),onConfirm:e[9]||(e[9]=s=>{E.value=!1,ie()}),heading:"Are you sure you want to retry the whole group?",body:"Retrying a whole group can take some time and put extra load on your system. Are you sure you want to retry all these messages?"})):v("",!0),N.value?(n(),f(U,{key:2,onCancel:e[10]||(e[10]=s=>N.value=!1),onConfirm:e[11]||(e[11]=s=>{N.value=!1,ue()}),heading:"Are you sure you want to delete this group?",body:"If you delete, the messages in the group won't be available for retrying unless they're later restored."})):v("",!0)]))])]),_:1})]),_:1}))}});export{He as default};
//# sourceMappingURL=FailedMessages-fFrUL4fI.js.map
