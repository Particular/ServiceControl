{"version":3,"file":"EndpointConnection-BW3iLiQy.js","sources":["../../../../frontend/src/components/configuration/EndpointConnection.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport { onMounted, ref } from \"vue\";\nimport LicenseNotExpired from \"../LicenseNotExpired.vue\";\nimport ServiceControlAvailable from \"../ServiceControlAvailable.vue\";\nimport CodeEditor from \"@/components/CodeEditor.vue\";\nimport { useServiceControlStore } from \"@/stores/ServiceControlStore\";\nimport { storeToRefs } from \"pinia\";\nimport LoadingSpinner from \"../LoadingSpinner.vue\";\n\ninterface ServiceControlInstanceConnection {\n  settings: { [key: string]: object };\n  errors: string[];\n}\n\ninterface MetricsConnectionDetails {\n  Enabled: boolean;\n  MetricsQueue?: string;\n  Interval?: string;\n}\n\nconst serviceControlStore = useServiceControlStore();\nconst { serviceControlUrl, monitoringUrl } = storeToRefs(serviceControlStore);\n\nconst loading = ref(true);\nconst showCodeOnlyTab = ref(true);\nconst jsonSnippet = ref(\"\");\nconst inlineSnippet = ref(\"\");\nconst jsonConfig = ref(\"\");\nconst queryErrors = ref<string[]>([]);\n\nasync function getCode() {\n  loading.value = true;\n\n  const snippetTemplate = `var servicePlatformConnection = ServicePlatformConnectionConfiguration.Parse(@\"<json>\");\n\n    endpointConfiguration.ConnectToServicePlatform(servicePlatformConnection);\n    `;\n\n  jsonSnippet.value = `var json = File.ReadAllText(\"<path-to-json-file>.json\");\nvar servicePlatformConnection = ServicePlatformConnectionConfiguration.Parse(json);\nendpointConfiguration.ConnectToServicePlatform(servicePlatformConnection);\n`;\n  const connections = await serviceControlConnections();\n  const config = {\n    Heartbeats: connections.serviceControl.settings.Heartbeats,\n    CustomChecks: connections.serviceControl.settings.CustomChecks,\n    ErrorQueue: connections.serviceControl.settings.ErrorQueue,\n    SagaAudit: connections.serviceControl.settings.SagaAudit,\n    MessageAudit: connections.serviceControl.settings.MessageAudit,\n    Metrics: connections.monitoring.settings,\n  };\n  let jsonText = JSON.stringify(config, null, 4);\n  jsonConfig.value = jsonText;\n\n  jsonText = jsonText.replaceAll('\"', '\"\"');\n  inlineSnippet.value = snippetTemplate.replace(\"<json>\", jsonText);\n\n  queryErrors.value = [];\n  queryErrors.value = queryErrors.value.concat(connections.serviceControl.errors || []);\n  queryErrors.value = queryErrors.value.concat(connections.monitoring.errors || []);\n\n  loading.value = false;\n}\n\nonMounted(async () => {\n  await getCode();\n});\n\nfunction switchCodeOnlyTab() {\n  showCodeOnlyTab.value = true;\n}\n\nfunction switchJsonTab() {\n  showCodeOnlyTab.value = false;\n}\n\nasync function serviceControlConnections() {\n  const scConnectionResult = getServiceControlConnection();\n  const monitoringConnectionResult = getMonitoringConnection();\n\n  const [scConnection, mConnection] = await Promise.all([scConnectionResult, monitoringConnectionResult]);\n  return {\n    serviceControl: {\n      settings: scConnection?.settings ?? {},\n      errors: scConnection?.errors ?? [],\n    } as ServiceControlInstanceConnection,\n    monitoring: {\n      settings: mConnection?.Metrics ?? ({ Enabled: false } as MetricsConnectionDetails),\n      errors: mConnection?.errors ?? [],\n    },\n  };\n}\n\nasync function getServiceControlConnection() {\n  try {\n    const [, data] = await serviceControlStore.fetchTypedFromServiceControl<ServiceControlInstanceConnection>(\"connection\");\n    return data;\n  } catch {\n    return { errors: [`Error reaching ServiceControl at ${serviceControlUrl.value} connection`] } as ServiceControlInstanceConnection;\n  }\n}\n\nasync function getMonitoringConnection() {\n  try {\n    const [, data] = await serviceControlStore.fetchTypedFromMonitoring<{ Metrics: MetricsConnectionDetails }>(\"connection\");\n    return { ...data, errors: [] };\n  } catch {\n    return { Metrics: null, errors: [`Error SC Monitoring instance at ${monitoringUrl.value}connection`] };\n  }\n}\n</script>\n\n<template>\n  <section name=\"platformconnection\">\n    <ServiceControlAvailable>\n      <LicenseNotExpired>\n        <div class=\"box configuration\">\n          <div class=\"row\">\n            <div class=\"col-12\">\n              <h3>Connect an endpoint to ServiceControl</h3>\n            </div>\n          </div>\n          <div class=\"row\">\n            <div class=\"col-12\">\n              <ol>\n                <li>Add the <a href=\"https://www.nuget.org/packages/NServiceBus.ServicePlatform.Connector/\">NServiceBus.ServicePlatform.Connector</a> NuGet package to the endpoint project.</li>\n                <li>Copy-paste the code from one of the options below. For additional options, refer to the <a href=\"https://docs.particular.net/platform/connecting\">documentation</a></li>\n              </ol>\n            </div>\n          </div>\n          <div class=\"row tabs-config-snippets\">\n            <div class=\"col-12\">\n              <LoadingSpinner v-show=\"loading\"></LoadingSpinner>\n\n              <!-- Nav tabs -->\n              <div v-if=\"!loading\" class=\"tabs\" role=\"tablist\">\n                <h5 :class=\"{ active: showCodeOnlyTab }\">\n                  <a @click=\"switchCodeOnlyTab()\" class=\"ng-binding\">Endpoint configuration only</a>\n                </h5>\n                <h5 :class=\"{ active: !showCodeOnlyTab }\">\n                  <a @click=\"switchJsonTab()\" class=\"ng-binding\">JSON file</a>\n                </h5>\n              </div>\n\n              <div v-if=\"queryErrors.length > 0 && !loading\" class=\"alert alert-warning\" role=\"alert\">\n                There were problems reaching some ServiceControl instances and the configuration does not contain all connectivity information.\n                <ul>\n                  <li v-for=\"error in queryErrors\" :key=\"error\">\n                    {{ error }}\n                  </li>\n                </ul>\n              </div>\n\n              <section v-if=\"showCodeOnlyTab && !loading\">\n                <div class=\"row\">\n                  <div class=\"col-12 h-100\">\n                    <CodeEditor :model-value=\"inlineSnippet\" language=\"csharp\" :show-gutter=\"false\"></CodeEditor>\n                  </div>\n                </div>\n              </section>\n\n              <section v-if=\"!showCodeOnlyTab && !loading\">\n                <div class=\"row\">\n                  <div class=\"col-12 h-100\">\n                    <p>Note that when using JSON for configuration, you also need to change the endpoint configuration as shown below.</p>\n                    <p><strong>Endpoint configuration:</strong></p>\n                    <CodeEditor :model-value=\"jsonSnippet\" language=\"csharp\" :show-gutter=\"false\"></CodeEditor>\n                    <p style=\"margin-top: 15px\">\n                      <strong>JSON configuration file:</strong>\n                    </p>\n                    <CodeEditor :model-value=\"jsonConfig\" language=\"json\" :show-gutter=\"false\"></CodeEditor>\n                  </div>\n                </div>\n              </section>\n            </div>\n          </div>\n        </div>\n      </LicenseNotExpired>\n    </ServiceControlAvailable>\n  </section>\n</template>\n\n<style scoped>\n.configuration :deep(pre) {\n  border: none;\n  background-color: #282c34;\n}\n\n.box > .row {\n  margin-left: 0;\n}\n\nsection[name=\"platformconnection\"] ol {\n  font-size: 16px;\n  padding-left: 18px;\n  margin: 15px 0 0;\n}\n\nsection[name=\"platformconnection\"] li {\n  margin-bottom: 15px;\n}\n\n:deep(.code) {\n  padding-bottom: 20px;\n}\n\n.tabs-config-snippets .tabs {\n  margin: 30px 0 15px;\n}\n\n.tabs-config-snippets highlight {\n  margin-bottom: 20px;\n  display: block;\n}\n\n.tabs-config-snippets p {\n  font-size: 16px;\n  color: #181919;\n}\n\n.tabs-config-snippets .alert {\n  margin-bottom: 15px;\n}\n\n.tabs-config-snippets .alert li {\n  margin-bottom: 0;\n}\n</style>\n"],"names":["serviceControlStore","useServiceControlStore","serviceControlUrl","monitoringUrl","storeToRefs","loading","ref","showCodeOnlyTab","jsonSnippet","inlineSnippet","jsonConfig","queryErrors","getCode","snippetTemplate","connections","serviceControlConnections","config","jsonText","onMounted","switchCodeOnlyTab","switchJsonTab","scConnectionResult","getServiceControlConnection","monitoringConnectionResult","getMonitoringConnection","scConnection","mConnection","data","_openBlock","_createElementBlock","_hoisted_1","_createVNode","ServiceControlAvailable","LicenseNotExpired","_createElementVNode","_hoisted_2","_hoisted_3","_hoisted_4","LoadingSpinner","_hoisted_5","_hoisted_6","_Fragment","_renderList","error","_hoisted_7","_hoisted_8","_hoisted_9","CodeEditor","_hoisted_10","_hoisted_11","_hoisted_12","_cache"],"mappings":"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"}