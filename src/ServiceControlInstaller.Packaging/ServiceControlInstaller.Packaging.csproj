<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net461</TargetFramework>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\ServiceControl.Transports.Learning\ServiceControl.Transports.Learning.csproj" />
    <ProjectReference Include="..\ServiceControl.Transports.SQS\ServiceControl.Transports.SQS.csproj" />
    <ProjectReference Include="..\ServiceControl\ServiceControl.csproj" />
    <ProjectReference Include="..\ServiceControl.Transports.ASB\ServiceControl.Transports.ASB.csproj" />
    <ProjectReference Include="..\ServiceControl.Transports.ASBS\ServiceControl.Transports.ASBS.csproj" />
    <ProjectReference Include="..\ServiceControl.Transports.ASQ\ServiceControl.Transports.ASQ.csproj" />
    <ProjectReference Include="..\ServiceControl.Transports.Msmq\ServiceControl.Transports.Msmq.csproj" />
    <ProjectReference Include="..\ServiceControl.Transports.RabbitMQ\ServiceControl.Transports.RabbitMQ.csproj" />
    <ProjectReference Include="..\ServiceControl.Transports.SqlServer\ServiceControl.Transports.SqlServer.csproj" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Packaging.ServiceControl.Monitoring" Version="2.1.7" PrivateAssets="All" />
  </ItemGroup>

  <UsingTask AssemblyFile="..\..\buildsupport\DeploymentZipTask.Dll" TaskName="DeploymentZipTask.AddToZip" />

  <Target Name="CreateServiceControlZip" AfterTargets="Build">
    <PropertyGroup>
      <ZipTargetFolder>..\..\zip\</ZipTargetFolder>
      <ZipToCreate>$(ZipTargetFolder)Particular.ServiceControl-$(GitVersion_MajorMinorPatch).zip</ZipToCreate>
    </PropertyGroup>
    <!-- Ensure Folder Exists  -->
    <MakeDir Directories="$(ZipTargetFolder)" />
    <!-- Remove any existing files -->
    <ItemGroup>
      <OldZips Include="$(ZipTargetFolder)*.*" />
    </ItemGroup>
    <Delete Files="@(OldZips)" />
    <!-- SQL Server -->
    <AddToZip IncludeMask="*.dll" ZipFileName="$(ZipToCreate)" SourceFolder="..\ServiceControl.Transports.SqlServer\$(OutputPath)" ZipFolder="Transports\SQLServer" />
    <!-- AzureStorageQueue -->
    <AddToZip IncludeMask="*.dll" ZipFileName="$(ZipToCreate)" SourceFolder="..\ServiceControl.Transports.ASQ\$(OutputPath)" ZipFolder="Transports\AzureStorageQueue" />
    <!-- AzureServiceBus -->
    <AddToZip IncludeMask="*.dll" ZipFileName="$(ZipToCreate)" SourceFolder="..\ServiceControl.Transports.ASB\$(OutputPath)" ZipFolder="Transports\AzureServiceBus" />
    <!--AzureServiceBus .NET Standard-->
    <AddToZip IncludeMask="*.dll" ZipFileName="$(ZipToCreate)" SourceFolder="..\ServiceControl.Transports.ASBS\$(OutputPath)" ZipFolder="Transports\NetStandardAzureServiceBus" />
    <!-- RabbitMQ -->
    <AddToZip IncludeMask="*.dll" ZipFileName="$(ZipToCreate)" SourceFolder="..\ServiceControl.Transports.RabbitMQ\$(OutputPath)" ZipFolder="Transports\RabbitMQ" />
    <!-- MSMQ -->
    <AddToZip IncludeMask="*.dll" ZipFileName="$(ZipToCreate)" SourceFolder="..\ServiceControl.Transports.Msmq\$(OutputPath)" ZipFolder="Transports\MSMQ" />
    <!-- SQS -->
    <AddToZip IncludeMask="*.dll" ZipFileName="$(ZipToCreate)" SourceFolder="..\ServiceControl.Transports.SQS\$(OutputPath)" ZipFolder="Transports\AmazonSQS" />
    <!-- LearningTransport -->
    <AddToZip IncludeMask="*.dll" ZipFileName="$(ZipToCreate)" SourceFolder="..\ServiceControl.Transports.Learning\$(OutputPath)" ZipFolder="Transports\LearningTransport" />
    <!-- ServiceControl  -->
    <AddToZip IncludeMask="*.*" ExcludeMask="*.config" ZipFileName="$(ZipToCreate)" ZipFolder="ServiceControl" SourceFolder="..\ServiceControl\bin\$(Configuration)\$(TargetFramework)" />
  </Target>

  <Target Name="CopyServiceControlMonitoringZip" AfterTargets="CreateServiceControlZip">
    <PropertyGroup>
      <ZipTargetFolder>..\..\zip\</ZipTargetFolder>
    </PropertyGroup>
    <ItemGroup>
      <Zips Include="$(NuGetPackageRoot)packaging.servicecontrol.monitoring\%(PackageReference.Version)\**\*monitoring*.zip" Condition="'%(PackageReference.Identity)' == 'Packaging.ServiceControl.Monitoring'" />
    </ItemGroup>
    <Copy SourceFiles="@(Zips)" DestinationFolder="$(ZipTargetFolder)" />
  </Target>

</Project>
