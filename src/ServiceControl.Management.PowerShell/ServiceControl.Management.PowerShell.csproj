<Project Sdk="Microsoft.NET.Sdk">

  <!--

  NOTE: No ProjectReferences or PackageReferences can be added to the project without first ensuring that they done in a way that
  doesn't break the dependency isolation required by the PowerShell module.
  See https://devblogs.microsoft.com/powershell/resolving-powershell-module-assembly-dependency-conflicts/

  -->

  <PropertyGroup>
    <!-- Must stay net6.0 to support PowerShell 7.2 LTS -->
    <TargetFramework>net6.0-windows</TargetFramework>

    <!--Ensures that all project references are explicitly defined in this file -->
    <DisableTransitiveProjectReferences>true</DisableTransitiveProjectReferences>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\ServiceControlInstaller.Engine\ServiceControlInstaller.Engine.csproj" Private="false" />
    <!--Even though we have this dependency, we are actually relying on the copy provided by ServiceControlInstaller.Engine at runtime -->
    <ProjectReference Include="..\ServiceControl.LicenseManagement\ServiceControl.LicenseManagement.csproj" Private="false" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="System.Management.Automation" />
  </ItemGroup>

  <ItemGroup>
    <Artifact Include="$(OutputPath)" DestinationFolder="$(PowerShellModuleArtifactsPath)" />
    <Artifact Include="$(PowerShellModuleName).psd1" DestinationFolder="$(PowerShellModuleArtifactsPath)" />
    <Artifact Include="$(PowerShellModuleName).psm1" DestinationFolder="$(PowerShellModuleArtifactsPath)" />
    <Artifact Include="$(PowerShellModuleName).format.ps1xml" DestinationFolder="$(PowerShellModuleArtifactsPath)" />
    <Artifact Include="ServiceControl.Management.PowerShell.dll-help.xml" DestinationFolder="$(PowerShellModuleArtifactsPath)" />
  </ItemGroup>

  <UsingTask TaskName="FileUpdate" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <Files ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <Pattern ParameterType="System.String" Required="true" />
      <ReplacementText ParameterType="System.String" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.Text.RegularExpressions" />
      <Using Namespace="System.IO" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
             RegexOptions options = RegexOptions.Multiline | RegexOptions.IgnoreCase;
             if (Files.Length > 0)
             {
                  ReplacementText ??= string.Empty;
                  if (Pattern == "{{Prerelease}}" && !string.IsNullOrEmpty(ReplacementText))
                  {
                      var parts = ReplacementText.Split('.');
                      var result = int.Parse(parts[1]);
                      ReplacementText = $"{parts[0]}{result:D4}";
                  }
                  for (int i = 0; i < Files.Length; i++)
                  {
                      var path = Files[i].GetMetadata("FullPath");
                      File.WriteAllText(path, Regex.Replace(File.ReadAllText(path), Pattern, ReplacementText, options));
                  }
              }
          ]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="UpdateModuleManifestVersion" DependsOnTargets="MinVer" AfterTargets="CopyArtifacts">
    <ItemGroup>
      <ModuleFile Include="$(PowerShellModuleArtifactsPath)$(PowerShellModuleName).psd1" />
    </ItemGroup>
    <FileUpdate Files="@(ModuleFile)" Pattern="{{Version}}" ReplacementText="$(MinVerMajor).$(MinVerMinor).$(MinVerPatch)" />
    <FileUpdate Files="@(ModuleFile)" Pattern="{{Prerelease}}" ReplacementText="$(MinVerPrerelease)" />
    <FileUpdate Files="@(ModuleFile)" Pattern="{{Date}}" ReplacementText="$([System.DateTime]::UtcNow.ToString(yyyy))" />
  </Target>

</Project>
